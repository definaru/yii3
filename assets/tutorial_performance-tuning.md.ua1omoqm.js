import{_ as e,c as a,o as s,V as i}from"./chunks/framework.szqEfhRr.js";const m=JSON.parse('{"title":"Performance tuning","description":"","frontmatter":{},"headers":[],"relativePath":"tutorial/performance-tuning.md","filePath":"tutorial/performance-tuning.md","lastUpdated":null}'),t={name:"tutorial/performance-tuning.md"},n=i(`<h1 id="performance-tuning" tabindex="-1">Performance tuning <a class="header-anchor" href="#performance-tuning" aria-label="Permalink to &quot;Performance tuning&quot;">​</a></h1><p>There are many factors affecting the performance of your application. Some are environmental, some are related to your code, while some others are related to Yii itself. In this section, we will count most of these factors and explain how you can improve your application performance by adjusting these factors.</p><h2 id="optimizing-your-php-environment" tabindex="-1">Optimizing your PHP Environment <span id="optimizing-php"></span> <a class="header-anchor" href="#optimizing-your-php-environment" aria-label="Permalink to &quot;Optimizing your PHP Environment &lt;span id=&quot;optimizing-php&quot;&gt;&lt;/span&gt;&quot;">​</a></h2><p>A well-configured PHP environment is important. To get maximum performance:</p><ul><li>Use the latest stable PHP version. Major releases of PHP may bring significant performance improvements.</li><li>Enable bytecode caching with <a href="https://secure.php.net/opcache" target="_blank" rel="noreferrer">Opcache</a>. Bytecode caching avoids the time spent in parsing and including PHP scripts for every incoming request.</li><li><a href="https://github.com/samdark/realpath_cache_tuner" target="_blank" rel="noreferrer">Tune <code>realpath()</code> cache</a>.</li><li>Make sure <a href="https://xdebug.org/" target="_blank" rel="noreferrer">XDebug</a> isn&#39;t installed in production environment.</li><li>Try <a href="https://wiki.php.net/rfc/preload" target="_blank" rel="noreferrer">PHP 7 preloading</a>.</li></ul><h2 id="using-caching-techniques" tabindex="-1">Using Caching Techniques <span id="using-caching"></span> <a class="header-anchor" href="#using-caching-techniques" aria-label="Permalink to &quot;Using Caching Techniques &lt;span id=&quot;using-caching&quot;&gt;&lt;/span&gt;&quot;">​</a></h2><p>You can use various caching techniques to significantly improve the performance of your application. For example, if your application allows users to enter text in Markdown format, you may consider caching the parsed Markdown content to avoid parsing the same Markdown text repeatedly in every request. Please refer to the <a href="./../caching/overview.html">Caching</a> section to learn about the caching support provided by Yii.</p><h2 id="optimizing-session-storage" tabindex="-1">Optimizing Session Storage <span id="optimizing-session"></span> <a class="header-anchor" href="#optimizing-session-storage" aria-label="Permalink to &quot;Optimizing Session Storage &lt;span id=&quot;optimizing-session&quot;&gt;&lt;/span&gt;&quot;">​</a></h2><p>By default, session data are stored in files. The implementation is locking a file from opening a session to the point it&#39;s closed either by <code>$session-&gt;close()</code> or at the end of request. While the session file is locked all other requests, which are trying to use the same session are blocked, that&#39;s waiting for the initial request to release session file. This is fine for development and probably small projects. But when it comes to handling massive concurrent requests, it&#39;s better to use more sophisticated storage, such as Redis.</p><p>It could be done either by <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-redis-server-as-a-session-handler-for-php-on-ubuntu-14-04" target="_blank" rel="noreferrer">configuring PHP via php.ini</a> or <a href="https://www.sitepoint.com/saving-php-sessions-in-redis/" target="_blank" rel="noreferrer">implementing SessionHandlerInterface</a> and configuring session service as follows:</p><div class="language-php vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\Yiisoft\\Session\\SessionInterface</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;class&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\Yiisoft\\Session\\Session</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &#39;__construct()&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [[], $myCustomSessionHandler],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="optimizing-databases" tabindex="-1">Optimizing Databases <span id="optimizing-databases"></span> <a class="header-anchor" href="#optimizing-databases" aria-label="Permalink to &quot;Optimizing Databases &lt;span id=&quot;optimizing-databases&quot;&gt;&lt;/span&gt;&quot;">​</a></h2><p>Executing DB queries and fetching data from databases are often the main performance bottleneck in a Web application. Although using <a href="./../caching/data.html">data caching</a> techniques may ease the performance hit, it doesn&#39;t fully solve the problem. When the database has enormous amounts of data, and the cached data are invalid, fetching the latest data could be prohibitively expensive without a proper database and query design.</p><p>A general technique to improve the performance of DB queries is to create indices for table columns that need to be filtered by. For example, if you need to look for a user record by <code>username</code>, you should create an index on <code>username</code>. Note that while indexing can make SELECT queries much faster, it will slow down INSERT, UPDATE and DELETE queries.</p><p>For complex DB queries, it&#39;s recommended that you create database views to save the query parsing and preparation time.</p><p>Last but not least, use <code>LIMIT</code> in your <code>SELECT</code> queries. This avoids fetching an overwhelming amount of data from the database and exhausting the memory allocated to PHP.</p><h2 id="optimizing-composer-autoloader" tabindex="-1">Optimizing Composer Autoloader <span id="optimizing-autoloader"></span> <a class="header-anchor" href="#optimizing-composer-autoloader" aria-label="Permalink to &quot;Optimizing Composer Autoloader &lt;span id=&quot;optimizing-autoloader&quot;&gt;&lt;/span&gt;&quot;">​</a></h2><p>Because Composer autoloader is used to include most third-party class files, you should consider optimizing it by executing the following command:</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>composer dumpautoload -o</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Additionally, you may consider using <a href="https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-a-authoritative-class-maps" target="_blank" rel="noreferrer">authoritative class maps</a> and <a href="https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-b-apcu-cache" target="_blank" rel="noreferrer">APCu cache</a>. Note that both optimizations may or may not be suitable for your particular case.</p><h2 id="processing-data-offline" tabindex="-1">Processing Data Offline <span id="processing-data-offline"></span> <a class="header-anchor" href="#processing-data-offline" aria-label="Permalink to &quot;Processing Data Offline &lt;span id=&quot;processing-data-offline&quot;&gt;&lt;/span&gt;&quot;">​</a></h2><p>When a request involves some resource intensive operations, you should think of ways to perform those operations in offline mode without having users wait for them to finish.</p><p>There are two methods to process data offline: pull and push.</p><p>In the pull method, whenever a request involves some complex operation, you create a task and save it in a persistent storage, such as a database. You then use a separate process (such as a cron job) to pull the tasks and process them. This method is easy to implement, but it has some drawbacks. For example, the task process needs to periodically pull from the task storage. If the pull frequency is too low, the tasks may be processed with great delay, but if the frequency is too high, it will introduce high overhead.</p><p>In the push method, you would use a message queue (e.g. RabbitMQ, ActiveMQ, Amazon SQS, etc.) to manage the tasks. Whenever a new task is put on the queue, it will initiate or notify the task handling process to trigger the task processing.</p><h2 id="using-preloading" tabindex="-1">Using preloading <a class="header-anchor" href="#using-preloading" aria-label="Permalink to &quot;Using preloading&quot;">​</a></h2><p>As of PHP 7.4.0, PHP can be configured to preload scripts into the opcache when the engine starts. You can read more in the <a href="https://www.php.net/manual/en/opcache.preloading.php" target="_blank" rel="noreferrer">documentation</a> and the corresponding <a href="https://wiki.php.net/rfc/preload" target="_blank" rel="noreferrer">RFC</a>.</p><p>Note that the optimal tradeoff between performance and memory may vary with the application. &quot;Preload everything&quot; may be the easiest strategy, but not necessarily the best strategy.</p><p>For example, we conducted a simple <a href="https://github.com/yiisoft/app" target="_blank" rel="noreferrer">yiisoft/app</a> application template benchmark. Without preloading and with preloading of the entire composer class map.</p><h3 id="preloading-benchmarks" tabindex="-1">Preloading benchmarks <a class="header-anchor" href="#preloading-benchmarks" aria-label="Permalink to &quot;Preloading benchmarks&quot;">​</a></h3><p>The application template benchmark includes configuring classes to injected dependencies in the bootstrap script.</p><p>For both variants, <a href="https://httpd.apache.org/docs/2.4/programs/ab.html" target="_blank" rel="noreferrer">ApacheBench</a> was used with the following run parameters:</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ab</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -c </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -t </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Also, a debug mode was disabled. And an optimized autoloader of the <a href="https://getcomposer.org" target="_blank" rel="noreferrer">Composer</a> was used and development dependencies weren&#39;t used:</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">composer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install --optimize-autoloader --no-dev</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>With preloading enabled, the entire composer class map (825 files) was used:</p><div class="language-php vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$files </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> require</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vendor/composer/autoload_classmap.php&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">foreach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">array_unique</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($files) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $file) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    opcache_compile_file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($file);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="test-results" tabindex="-1">Test results <a class="header-anchor" href="#test-results" aria-label="Permalink to &quot;Test results&quot;">​</a></h4><table><thead><tr><th>Benchmark</th><th>Preloaded files</th><th>Opcache memory used</th><th>Per request memory used</th><th>Time per request</th><th>Requests per second</th></tr></thead><tbody><tr><td>Without preloading</td><td>0</td><td>12.32 mb</td><td>1.71 mb</td><td>27.63 ms</td><td>36.55 rq/s</td></tr><tr><td>With preloading</td><td>825</td><td>17.86 mb</td><td>1.82 mb</td><td>26.21 ms</td><td>38.42 rq/s</td></tr></tbody></table><p>As you can see, the test results aren&#39;t much different, since this is just a clean application template that doesn&#39;t contain many classes. More discussion of preloading, including benchmarks, can be found in the <a href="https://github.com/composer/composer/issues/7777" target="_blank" rel="noreferrer">composer&#39;s issue</a>.</p><h2 id="performance-profiling" tabindex="-1">Performance Profiling <span id="performance-profiling"></span> <a class="header-anchor" href="#performance-profiling" aria-label="Permalink to &quot;Performance Profiling &lt;span id=&quot;performance-profiling&quot;&gt;&lt;/span&gt;&quot;">​</a></h2><p>You should profile your code to find out the performance bottlenecks and take appropriate measures accordingly. The following profiling tools may be useful:</p><ul><li><a href="https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md" target="_blank" rel="noreferrer">Yii debug toolbar and debugger</a></li><li><a href="https://blackfire.io/" target="_blank" rel="noreferrer">Blackfire</a></li><li><a href="https://secure.php.net/manual/en/book.xhprof.php" target="_blank" rel="noreferrer">XHProf</a></li><li><a href="https://xdebug.org/docs/profiler" target="_blank" rel="noreferrer">XDebug profiler</a></li></ul>`,43),r=[n];function o(l,p,h,d,c,u){return s(),a("div",null,r)}const f=e(t,[["render",o]]);export{m as __pageData,f as default};
